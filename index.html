<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Greencare Discharge Analysis - June 2025</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 50%, #334155 100%);
            min-height: 100vh;
            padding: 20px;
            color: white;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        .header {
            text-align: center;
            margin-bottom: 40px;
        }
        
        .header h1 {
            font-size: 3rem;
            color: #f1f5f9;
            margin-bottom: 10px;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }
        
        .header p {
            color: #cbd5e1;
            font-size: 1.2rem;
            margin-bottom: 5px;
        }
        
        .header .date {
            color: #94a3b8;
            font-size: 1rem;
        }
        
        .data-source {
            background: rgba(59, 130, 246, 0.1);
            border: 1px solid #3b82f6;
            color: #93c5fd;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 30px;
            text-align: center;
        }
        
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 25px;
            margin-bottom: 40px;
        }
        
        .metric-card {
            background: linear-gradient(145deg, #1e293b 0%, #334155 100%);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.3);
            border: 1px solid #475569;
            text-align: center;
            position: relative;
            overflow: hidden;
        }
        
        .metric-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #ef4444, #f59e0b, #10b981);
        }
        
        .metric-title {
            color: #cbd5e1;
            font-size: 0.9rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 15px;
        }
        
        .metric-value {
            font-size: 2.8rem;
            font-weight: 700;
            color: #f1f5f9;
            margin-bottom: 10px;
        }
        
        .metric-subtitle {
            color: #94a3b8;
            font-size: 0.9rem;
        }
        
        .risk-indicator {
            display: inline-flex;
            align-items: center;
            padding: 6px 12px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 0.8rem;
            margin-top: 10px;
        }
        
        .risk-high {
            background: rgba(239, 68, 68, 0.2);
            color: #ef4444;
            border: 1px solid #ef4444;
        }
        
        .risk-medium {
            background: rgba(245, 158, 11, 0.2);
            color: #f59e0b;
            border: 1px solid #f59e0b;
        }
        
        .risk-low {
            background: rgba(16, 185, 129, 0.2);
            color: #10b981;
            border: 1px solid #10b981;
        }
        
        .chart-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
            gap: 30px;
            margin-bottom: 40px;
        }
        
        .chart-container {
            background: linear-gradient(145deg, #1e293b 0%, #334155 100%);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.3);
            border: 1px solid #475569;
        }
        
        .chart-title {
            font-size: 1.4rem;
            font-weight: 600;
            color: #f1f5f9;
            margin-bottom: 25px;
            text-align: center;
        }
        
        .chart-canvas {
            position: relative;
            height: 400px;
        }
        
        .practitioners-table {
            background: linear-gradient(145deg, #1e293b 0%, #334155 100%);
            border-radius: 20px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.3);
            overflow: hidden;
            border: 1px solid #475569;
            margin-bottom: 30px;
        }
        
        .table-header {
            padding: 30px;
            color: white;
        }
        
        .table-header h2 {
            font-size: 1.6rem;
            margin-bottom: 8px;
            text-align: center;
        }
        
        .table-header p {
            text-align: center;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
        }
        
        th, td {
            padding: 18px 25px;
            text-align: left;
            border-bottom: 1px solid #475569;
        }
        
        th {
            background: #2d3748;
            font-weight: 600;
            color: #e2e8f0;
            text-transform: uppercase;
            font-size: 0.8rem;
            letter-spacing: 0.5px;
            cursor: pointer;
            user-select: none;
            position: relative;
            transition: background-color 0.2s;
        }
        
        th:hover {
            background: #4a5568;
        }
        
        th.sortable::after {
            content: ' ‚ÜïÔ∏è';
            font-size: 0.7rem;
            opacity: 0.5;
        }
        
        th.sort-asc::after {
            content: ' ‚Üë';
            opacity: 1;
        }
        
        th.sort-desc::after {
            content: ' ‚Üì';
            opacity: 1;
        }
        
        td {
            color: #cbd5e1;
        }
        
        .status-badge {
            display: inline-flex;
            align-items: center;
            padding: 6px 12px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 0.8rem;
        }
        
        .status-critical {
            background: rgba(239, 68, 68, 0.2);
            color: #ef4444;
            border: 1px solid #ef4444;
        }
        
        .status-warning {
            background: rgba(245, 158, 11, 0.2);
            color: #f59e0b;
            border: 1px solid #f59e0b;
        }
        
        .status-good {
            background: rgba(16, 185, 129, 0.2);
            color: #10b981;
            border: 1px solid #10b981;
        }
        
        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 50vh;
            flex-direction: column;
        }
        
        .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid #475569;
            border-top: 4px solid #3b82f6;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .insight-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        
        .insight-card {
            background: linear-gradient(145deg, #1e293b 0%, #334155 100%);
            border-radius: 15px;
            padding: 20px;
            border: 1px solid #475569;
        }
        
        .insight-card h4 {
            color: #3b82f6;
            margin-bottom: 10px;
            font-size: 1.1rem;
        }
        
        .insight-card p {
            color: #cbd5e1;
            margin-bottom: 10px;
            line-height: 1.4;
        }
        
        .highlight-stat {
            background: rgba(59, 130, 246, 0.1);
            color: #93c5fd;
            padding: 8px 12px;
            border-radius: 8px;
            font-weight: 600;
            display: inline-block;
            margin: 5px 5px 5px 0;
        }
        
        .correlation-positive {
            color: #10b981;
            font-weight: 600;
        }
        
        .correlation-negative {
            color: #ef4444;
            font-weight: 600;
        }
        
        .correlation-neutral {
            color: #f59e0b;
            font-weight: 600;
        }
        
        .update-info {
            background: linear-gradient(145deg, #1e293b 0%, #334155 100%);
            border-radius: 15px;
            padding: 20px;
            margin-top: 30px;
            border: 1px solid #475569;
        }
        
        .update-info h3 {
            color: #f1f5f9;
            margin-bottom: 10px;
            text-align: center;
        }
        
        .update-info p {
            color: #cbd5e1;
            font-size: 0.9rem;
        }
        
        @media (max-width: 768px) {
            .header h1 {
                font-size: 2.2rem;
            }
            
            .metrics-grid {
                grid-template-columns: 1fr;
            }
            
            .chart-grid {
                grid-template-columns: 1fr;
            }
            
            .chart-canvas {
                height: 300px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üìä Greencare Discharge Analysis</h1>
            <p>Patient & Practitioner Discharge Monitoring</p>
            <p class="date">June 2025 ‚Ä¢ Risk Assessment Dashboard</p>
        </div>
        
        <div id="loading" class="loading">
            <div class="spinner"></div>
            <div style="color: #cbd5e1;">Loading discharge data from Google Sheets...</div>
        </div>
        
        <div id="dashboard" style="display: none;">
            <div id="dataSource" class="data-source">
                üìä Data loaded from Google Sheets ‚Ä¢ Last updated: <span id="lastUpdated"></span>
            </div>
            
            <div class="practitioners-table">
                <div class="table-header" style="background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);">
                    <h2>üìã Quick Summary</h2>
                    <p>Key performance metrics at a glance</p>
                </div>
                <div style="padding: 20px;">
                    <div id="quickSummaryContent">
                        <!-- Quick summary will be populated here -->
                    </div>
                </div>
            </div>
            
            <div class="metrics-grid">
                <div class="metric-card">
                    <div class="metric-title">Total Practitioners</div>
                    <div class="metric-value" id="totalPractitioners">0</div>
                    <div class="metric-subtitle">Active practitioners tracked</div>
                </div>
                
                <div class="metric-card">
                    <div class="metric-title">Total Consultations</div>
                    <div class="metric-value" id="totalConsultations">0</div>
                    <div class="metric-subtitle">Combined consultation volume</div>
                </div>
                
                <div class="metric-card">
                    <div class="metric-title">Avg Patient Discharge Rate</div>
                    <div class="metric-value" id="avgPatientDischarge">0%</div>
                    <div class="metric-subtitle">Patient-initiated discharges</div>
                    <div class="risk-indicator" id="patientRiskIndicator"></div>
                </div>
                
                <div class="metric-card">
                    <div class="metric-title">Avg Practitioner Discharge Rate</div>
                    <div class="metric-value" id="avgPractitionerDischarge">0%</div>
                    <div class="metric-subtitle">Practitioner-initiated discharges</div>
                    <div class="risk-indicator" id="practitionerRiskIndicator"></div>
                </div>
                
                <div class="metric-card">
                    <div class="metric-title">Overall Discharge Rate</div>
                    <div class="metric-value" id="overallDischarge">0%</div>
                    <div class="metric-subtitle">Combined discharge rate</div>
                    <div class="risk-indicator" id="overallRiskIndicator"></div>
                </div>
                
                <div class="metric-card">
                    <div class="metric-title">Best Performer</div>
                    <div class="metric-value" id="bestPerformerName">-</div>
                    <div class="metric-subtitle" id="bestPerformerRate">Lowest overall rate</div>
                    <div class="risk-indicator risk-low">Excellent</div>
                </div>
            </div>
            
            <div class="chart-grid">
                <div class="chart-container">
                    <div class="chart-title">üìä Discharge Rates by Practitioner</div>
                    <div class="chart-canvas">
                        <canvas id="dischargeChart"></canvas>
                    </div>
                </div>
                
                <div class="chart-container">
                    <div class="chart-title">üéØ Discharge Type Distribution</div>
                    <div class="chart-canvas">
                        <canvas id="distributionChart"></canvas>
                    </div>
                </div>
            </div>
            
            <div class="practitioners-table">
                <div class="table-header" style="background: linear-gradient(135deg, #475569 0%, #374151 100%);">
                    <h2>Detailed Practitioner Analysis</h2>
                    <p>Individual discharge rates and risk assessment</p>
                </div>
                <table>
                    <thead>
                        <tr>
                            <th class="sortable" data-column="name">Practitioner</th>
                            <th class="sortable" data-column="appointments">Appointments</th>
                            <th class="sortable" data-column="workloadShare">% of Total Consults</th>
                            <th class="sortable" data-column="patientDischarge">Patient Discharge %</th>
                            <th class="sortable" data-column="practitionerDischarge">Practitioner Discharge %</th>
                            <th class="sortable" data-column="overallDischarge">Overall Discharge %</th>
                            <th class="sortable" data-column="riskLevel">Risk Level</th>
                            <th>Action Required</th>
                        </tr>
                    </thead>
                    <tbody id="practitionersTable">
                        <!-- Data will be populated here -->
                    </tbody>
                </table>
            </div>
            
            <div id="insightsSection" class="practitioners-table">
                <div class="table-header" style="background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);">
                    <h2>üí° Statistical Insights & Analysis</h2>
                    <p>Data-driven insights accounting for consultation volume and statistical significance</p>
                </div>
                <div style="padding: 30px;">
                    <div id="insightsContent">
                        <!-- Insights will be populated here -->
                    </div>
                </div>
            </div>
            
            <div id="recommendationsSection" class="practitioners-table">
                <div class="table-header" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%);">
                    <h2>üéØ Strategic Recommendations</h2>
                    <p>Actionable steps to improve patient retention and operational efficiency</p>
                </div>
                <div style="padding: 30px;">
                    <div id="recommendationsContent">
                        <!-- Recommendations will be populated here -->
                    </div>
                </div>
            </div>
            
            <div class="update-info">
                <h3>üîÑ Auto-Update System</h3>
                <p><strong>How it works:</strong> This dashboard automatically pulls the latest discharge data from your Google Sheets every time the page loads. Data is analyzed to identify high-risk practitioners and discharge patterns.</p>
                <p><strong>Risk Thresholds:</strong> Patient discharge >15% = High Risk ‚Ä¢ Practitioner discharge >10% = Review Required ‚Ä¢ Overall >20% = Critical</p>
            </div>
        </div>
    </div>

    <script>
        // Google Sheets CSV URL for discharge data - JUNE SUMMARY - DISCHARGES sheet
        const DISCHARGE_CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vR9oDIgQ5APmcCORpmydY4Kxuwd2RPyLEG41QggNecWvPM_xbHBEcp14Pwj9lxkn9OxryuMq5SUFbsd/pub?gid=1648608059&single=true&output=csv';
        
        let charts = {};
        let currentSortColumn = 'patientDischarge';
        let currentSortDirection = 'desc';
        let practitionersData = [];

        // Fetch discharge data from Google Sheets
        async function fetchDischargeData() {
            try {
                console.log('Fetching discharge data from Google Sheets...');
                
                // Try direct fetch first
                try {
                    const directResponse = await fetch(DISCHARGE_CSV_URL);
                    if (directResponse.ok) {
                        const csvText = await directResponse.text();
                        console.log('Direct CSV fetch successful, length:', csvText.length);
                        return parseDischargeCSV(csvText);
                    }
                } catch (directError) {
                    console.log('Direct fetch failed, trying CORS proxy...');
                }
                
                // Use CORS proxy as fallback
                const proxyUrl = `https://api.allorigins.win/get?url=${encodeURIComponent(DISCHARGE_CSV_URL)}`;
                const response = await fetch(proxyUrl);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                const csvText = data.contents;
                
                console.log('Proxy CSV fetch successful, length:', csvText.length);
                return parseDischargeCSV(csvText);
                
            } catch (error) {
                console.error('Error fetching discharge data:', error);
                
                // Show error to user
                document.getElementById('dataSource').innerHTML = `
                    ‚ö†Ô∏è <strong>Data Connection Failed</strong><br>
                    Error: ${error.message}<br>
                    Using demo data for testing.
                `;
                document.getElementById('dataSource').style.background = 'rgba(239, 68, 68, 0.1)';
                document.getElementById('dataSource').style.borderColor = '#ef4444';
                document.getElementById('dataSource').style.color = '#fca5a5';
                
                // Return demo data
                return [
                    { name: 'Dr. Sarah Mitchell', patientDischarge: 12.5, practitionerDischarge: 8.2, appointments: 142, overallDischarge: 20.7 },
                    { name: 'Dr. James Wilson', patientDischarge: 18.3, practitionerDischarge: 5.1, appointments: 89, overallDischarge: 23.4 },
                    { name: 'Dr. Emily Chen', patientDischarge: 9.7, practitionerDischarge: 12.8, appointments: 203, overallDischarge: 22.5 },
                    { name: 'Dr. Michael Brown', patientDischarge: 15.2, practitionerDischarge: 7.3, appointments: 156, overallDischarge: 22.5 },
                    { name: 'Dr. Lisa Davis', patientDischarge: 6.8, practitionerDischarge: 4.2, appointments: 178, overallDischarge: 11.0 },
                    { name: 'Dr. Robert Taylor', patientDischarge: 21.1, practitionerDischarge: 3.9, appointments: 67, overallDischarge: 25.0 },
                    { name: 'Dr. Amanda White', patientDischarge: 4.2, practitionerDischarge: 6.1, appointments: 134, overallDischarge: 10.3 }
                ];
            }
        }

        // Parse CSV data for discharge information
        function parseDischargeCSV(csvText) {
            console.log('Parsing discharge CSV data...');
            const lines = csvText.trim().split('\n');
            console.log('Total lines found:', lines.length);
            
            const practitioners = [];
            
            // Process rows 3-18 for data (array indices 2-17)
            for (let i = 2; i < Math.min(18, lines.length); i++) {
                const line = lines[i];
                if (!line || line.trim() === '') continue;
                
                // Handle CSV parsing with quoted fields
                const columns = parseCSVLine(line);
                
                // Extract columns H, J, L, N, O (indices 7, 9, 11, 13, 14)
                const name = columns[7] ? columns[7].trim() : '';
                const patientDischargeRaw = columns[9] ? columns[9].trim() : '';
                const practitionerDischargeRaw = columns[11] ? columns[11].trim() : '';
                const appointmentsRaw = columns[13] ? columns[13].trim() : '';
                const overallDischargeRaw = columns[14] ? columns[14].trim() : '';
                
                const patientDischarge = parseFloat(patientDischargeRaw) || 0;
                const practitionerDischarge = parseFloat(practitionerDischargeRaw) || 0;
                const appointments = parseInt(appointmentsRaw) || 0;
                const overallDischarge = parseFloat(overallDischargeRaw) || 0;
                
                // Only include practitioners with meaningful data
                if (name && name !== '' && !name.toLowerCase().includes('total') && !name.toLowerCase().includes('practitioner name') && appointments > 0) {
                    practitioners.push({
                        name: name,
                        patientDischarge: patientDischarge,
                        practitionerDischarge: practitionerDischarge,
                        appointments: appointments,
                        overallDischarge: overallDischarge
                    });
                    console.log(`Added: ${name} - ${patientDischarge}%/${practitionerDischarge}%/${overallDischarge}% (${appointments} appointments)`);
                }
            }
            
            console.log('Final practitioners:', practitioners);
            return practitioners;
        }

        // Parse a single CSV line handling quoted fields
        function parseCSVLine(line) {
            const columns = [];
            let current = '';
            let inQuotes = false;
            
            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                if (char === '"') {
                    inQuotes = !inQuotes;
                } else if (char === ',' && !inQuotes) {
                    columns.push(current.replace(/"/g, ''));
                    current = '';
                } else {
                    current += char;
                }
            }
            columns.push(current.replace(/"/g, ''));
            return columns;
        }

        // Calculate risk level based on discharge rates
        function calculateRiskLevel(patientRate, practitionerRate, overallRate) {
            if (patientRate > 15 || overallRate > 20) return 'critical';
            if (patientRate > 10 || practitionerRate > 10 || overallRate > 15) return 'warning';
            return 'good';
        }

        // Get risk indicator HTML
        function getRiskIndicator(rate, type = 'patient') {
            let threshold = type === 'patient' ? 15 : type === 'practitioner' ? 10 : 20;
            let warningThreshold = type === 'patient' ? 10 : type === 'practitioner' ? 7 : 15;
            
            if (rate > threshold) {
                return '<span class="risk-high">High Risk</span>';
            } else if (rate > warningThreshold) {
                return '<span class="risk-medium">Medium Risk</span>';
            } else {
                return '<span class="risk-low">Low Risk</span>';
            }
        }

        // Update dashboard with discharge data
        function updateDashboard(data) {
            // Calculate total appointments for workload analysis
            const totalAppointments = data.reduce((sum, p) => sum + p.appointments, 0);
            
            // Add workload share to each practitioner
            data.forEach(practitioner => {
                practitioner.workloadShare = (practitioner.appointments / totalAppointments) * 100;
            });
            
            // Update last updated time
            document.getElementById('lastUpdated').textContent = new Date().toLocaleString();
            
            // Calculate metrics
            const totalPractitioners = data.length;
            const avgPatientDischarge = data.reduce((sum, p) => sum + p.patientDischarge, 0) / totalPractitioners;
            const avgPractitionerDischarge = data.reduce((sum, p) => sum + p.practitionerDischarge, 0) / totalPractitioners;
            const avgOverallDischarge = data.reduce((sum, p) => sum + p.overallDischarge, 0) / totalPractitioners;
            
            // Find best performer
            const bestPerformer = data.reduce((min, p) => p.overallDischarge < min.overallDischarge ? p : min, data[0]);
            
            // Update metric cards
            document.getElementById('totalPractitioners').textContent = totalPractitioners;
            document.getElementById('totalConsultations').textContent = totalAppointments.toLocaleString();
            document.getElementById('avgPatientDischarge').textContent = `${avgPatientDischarge.toFixed(1)}%`;
            document.getElementById('avgPractitionerDischarge').textContent = `${avgPractitionerDischarge.toFixed(1)}%`;
            document.getElementById('overallDischarge').textContent = `${avgOverallDischarge.toFixed(1)}%`;
            
            document.getElementById('bestPerformerName').textContent = bestPerformer.name;
            document.getElementById('bestPerformerRate').textContent = `${bestPerformer.overallDischarge.toFixed(1)}% overall discharge`;
            
            // Update risk indicators
            document.getElementById('patientRiskIndicator').innerHTML = getRiskIndicator(avgPatientDischarge, 'patient');
            document.getElementById('practitionerRiskIndicator').innerHTML = getRiskIndicator(avgPractitionerDischarge, 'practitioner');
            document.getElementById('overallRiskIndicator').innerHTML = getRiskIndicator(avgOverallDischarge, 'overall');
            
            // Check for high-risk practitioners (removed alert display)
            const highRiskPractitioners = data.filter(p => p.patientDischarge > 15 || p.overallDischarge > 20);
            // Alert section removed as requested
            
            // Update quick summary
            updateQuickSummary(data, totalAppointments, avgPatientDischarge, avgPractitionerDischarge, avgOverallDischarge);
            
            // Update table
            updatePractitionersTable(data);
            
            // Generate and update insights
            const insights = generateInsights(data);
            updateInsightsSection(insights);
            
            // Generate and update recommendations
            const recommendations = generateRecommendations(data);
            updateRecommendationsSection(recommendations);
            
            // Update charts
            createDischargeCharts(data);
        }

        // Update quick summary section
        function updateQuickSummary(data, totalAppointments, avgPatientDischarge, avgPractitionerDischarge, avgOverallDischarge) {
            const highRiskCount = data.filter(p => p.overallDischarge > 20).length;
            const criticalWorkload = data.filter(p => p.workloadShare > 20).length;
            const bestPerformer = data.reduce((min, p) => p.overallDischarge < min.overallDischarge ? p : min, data[0]);
            
            const content = document.getElementById('quickSummaryContent');
            content.innerHTML = `
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px;">
                    <div style="text-align: center; padding: 15px; background: rgba(59, 130, 246, 0.1); border-radius: 10px; border: 1px solid #3b82f6;">
                        <h4 style="color: #3b82f6; margin-bottom: 8px;">Overall Performance</h4>
                        <p style="color: #cbd5e1;">Average discharge rate: <strong>${avgOverallDischarge.toFixed(1)}%</strong></p>
                        <p style="color: #cbd5e1;">Total consultations: <strong>${totalAppointments.toLocaleString()}</strong></p>
                    </div>
                    <div style="text-align: center; padding: 15px; background: rgba(16, 185, 129, 0.1); border-radius: 10px; border: 1px solid #10b981;">
                        <h4 style="color: #10b981; margin-bottom: 8px;">Best Performer</h4>
                        <p style="color: #cbd5e1;"><strong>${bestPerformer.name}</strong></p>
                        <p style="color: #cbd5e1;">${bestPerformer.overallDischarge.toFixed(1)}% discharge rate, ${bestPerformer.workloadShare.toFixed(1)}% workload</p>
                    </div>
                    <div style="text-align: center; padding: 15px; background: rgba(245, 158, 11, 0.1); border-radius: 10px; border: 1px solid #f59e0b;">
                        <h4 style="color: #f59e0b; margin-bottom: 8px;">Areas for Attention</h4>
                        <p style="color: #cbd5e1;"><strong>${highRiskCount}</strong> practitioners with >20% discharge rate</p>
                        <p style="color: #cbd5e1;"><strong>${criticalWorkload}</strong> practitioners handling >20% of workload</p>
                    </div>
                </div>
            `;
        }

        // Update practitioners table with sorting functionality
        function updatePractitionersTable(data) {
            practitionersData = data;
            const tbody = document.getElementById('practitionersTable');
            tbody.innerHTML = '';
            
            // Sort data
            const sortedData = [...data].sort((a, b) => {
                let aVal = a[currentSortColumn];
                let bVal = b[currentSortColumn];
                
                if (currentSortColumn === 'name') {
                    aVal = aVal.toLowerCase();
                    bVal = bVal.toLowerCase();
                } else if (currentSortColumn === 'riskLevel') {
                    const riskOrder = { 'critical': 3, 'warning': 2, 'good': 1 };
                    aVal = riskOrder[calculateRiskLevel(a.patientDischarge, a.practitionerDischarge, a.overallDischarge)];
                    bVal = riskOrder[calculateRiskLevel(b.patientDischarge, b.practitionerDischarge, b.overallDischarge)];
                }
                
                if (currentSortDirection === 'asc') {
                    return aVal > bVal ? 1 : -1;
                } else {
                    return aVal < bVal ? 1 : -1;
                }
            });
            
            // Update table headers
            document.querySelectorAll('th.sortable').forEach(th => {
                th.classList.remove('sort-asc', 'sort-desc');
                if (th.dataset.column === currentSortColumn) {
                    th.classList.add(currentSortDirection === 'asc' ? 'sort-asc' : 'sort-desc');
                }
            });
            
            sortedData.forEach(practitioner => {
                const riskLevel = calculateRiskLevel(
                    practitioner.patientDischarge, 
                    practitioner.practitionerDischarge, 
                    practitioner.overallDischarge
                );
                
                let statusClass = 'status-good';
                let statusText = 'Monitor';
                let actionText = 'Continue monitoring';
                
                if (riskLevel === 'critical') {
                    statusClass = 'status-critical';
                    statusText = 'Critical';
                    actionText = 'Immediate review';
                } else if (riskLevel === 'warning') {
                    statusClass = 'status-warning';
                    statusText = 'Warning';
                    actionText = 'Schedule review';
                }
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td><strong>${practitioner.name}</strong></td>
                    <td><strong>${practitioner.appointments.toLocaleString()}</strong></td>
                    <td><strong>${practitioner.workloadShare.toFixed(1)}%</strong></td>
                    <td><strong>${practitioner.patientDischarge.toFixed(1)}%</strong></td>
                    <td>${practitioner.practitionerDischarge.toFixed(1)}%</td>
                    <td><strong>${practitioner.overallDischarge.toFixed(1)}%</strong></td>
                    <td><span class="status-badge ${statusClass}">${statusText}</span></td>
                    <td>${actionText}</td>
                `;
                tbody.appendChild(row);
            });
            
            // Add click handlers for sorting
            document.querySelectorAll('th.sortable').forEach(th => {
                th.onclick = () => sortTable(th.dataset.column);
            });
        }
        
        // Sort table by column
        function sortTable(column) {
            if (currentSortColumn === column) {
                currentSortDirection = currentSortDirection === 'asc' ? 'desc' : 'asc';
            } else {
                currentSortColumn = column;
                currentSortDirection = 'desc';
            }
            updatePractitionersTable(practitionersData);
        }

        // Generate statistical insights with medicinal cannabis clinic context
        function generateInsights(data) {
            const insights = [];
            
            // Calculate key metrics
            const totalAppointments = data.reduce((sum, p) => sum + p.appointments, 0);
            const avgPatientDischarge = data.reduce((sum, p) => sum + p.patientDischarge, 0) / data.length;
            const avgPractitionerDischarge = data.reduce((sum, p) => sum + p.practitionerDischarge, 0) / data.length;
            
            // Workload vs Discharge Analysis
            const highWorkload = data.filter(p => p.workloadShare >= 15);
            const lowWorkload = data.filter(p => p.workloadShare < 10);
            
            if (highWorkload.length > 0 && lowWorkload.length > 0) {
                const highWorkloadAvgDischarge = highWorkload.reduce((sum, p) => sum + p.overallDischarge, 0) / highWorkload.length;
                const lowWorkloadAvgDischarge = lowWorkload.reduce((sum, p) => sum + p.overallDischarge, 0) / lowWorkload.length;
                
                insights.push({
                    title: "‚öñÔ∏è Practitioner Workload Impact on Patient Retention",
                    content: `
                        <p>Practitioners handling <span class="highlight-stat">‚â•15% of total consultations</span> have an average discharge rate of <span class="highlight-stat">${highWorkloadAvgDischarge.toFixed(1)}%</span></p>
                        <p>Practitioners handling <span class="highlight-stat">&lt;10% of consultations</span> have an average discharge rate of <span class="highlight-stat">${lowWorkloadAvgDischarge.toFixed(1)}%</span></p>
                        <p><strong>Clinical Insight:</strong> <span class="${highWorkloadAvgDischarge > lowWorkloadAvgDischarge ? 'correlation-negative' : 'correlation-positive'}">${highWorkloadAvgDischarge > lowWorkloadAvgDischarge ? 'High caseloads may be affecting clinical decision-making and patient relationships' : 'Experienced practitioners with higher caseloads maintain better patient retention'}</span></p>
                        <p><strong>Business Impact:</strong> Each 1% reduction in discharge rate could retain ~${Math.round(totalAppointments * 0.01)} patients annually</p>
                    `
                });
            }
            
            // Patient vs Practitioner Discharge Pattern Analysis
            insights.push({
                title: "üéØ Discharge Pattern Analysis - Revenue Impact",
                content: `
                    <p><strong>Patient-Initiated Discharges:</strong> <span class="highlight-stat">${avgPatientDischarge.toFixed(1)}%</span> (patients choosing to leave)</p>
                    <p><strong>Practitioner-Initiated Discharges:</strong> <span class="highlight-stat">${avgPractitionerDischarge.toFixed(1)}%</span> (clinical decisions)</p>
                    <p><strong>Key Insight:</strong> ${avgPatientDischarge > avgPractitionerDischarge ? 
                        '<span class="correlation-negative">Patient-initiated discharges are higher</span> - suggests issues with cost, efficacy expectations, or patient experience' : 
                        '<span class="correlation-negative">Practitioner-initiated discharges are higher</span> - suggests potential for clinical protocol optimization'}</p>
                    <p><strong>Medicinal Cannabis Context:</strong> ${avgPatientDischarge > avgPractitionerDischarge ? 
                        'Focus on patient education, cost management, and expectation setting to reduce voluntary exits' : 
                        'Review clinical discharge criteria and consider longer trial periods or alternative treatment approaches'}</p>
                `
            });
            
            // Revenue and Patient Lifetime Value Analysis
            const highestVolume = data.reduce((max, p) => p.appointments > max.appointments ? p : max, data[0]);
            const mostProblematic = data.reduce((max, p) => p.overallDischarge > max.overallDischarge ? p : max, data[0]);
            const estimatedLostPatients = Math.round((mostProblematic.overallDischarge / 100) * mostProblematic.appointments);
            
            insights.push({
                title: "üí∞ Patient Lifetime Value & Revenue Risk",
                content: `
                    <p><strong>Highest Volume Practitioner:</strong> <span class="highlight-stat">${highestVolume.name}</span> handling <span class="highlight-stat">${highestVolume.workloadShare.toFixed(1)}%</span> of consultations with <span class="highlight-stat">${highestVolume.overallDischarge.toFixed(1)}%</span> discharge rate</p>
                    <p><strong>Highest Discharge Rate:</strong> <span class="highlight-stat">${mostProblematic.name}</span> at <span class="highlight-stat">${mostProblematic.overallDischarge.toFixed(1)}%</span> (approximately ${estimatedLostPatients} patients lost)</p>
                    <p><strong>Total Consultation Volume:</strong> <span class="highlight-stat">${totalAppointments.toLocaleString()}</span> across all practitioners</p>
                    <p><strong>Revenue Insight:</strong> Reducing discharge rates by 5% could retain ~${Math.round(totalAppointments * 0.05)} patients, potentially worth ${Math.round(totalAppointments * 0.05 * 6 * 200).toLocaleString()} in follow-up revenue annually</p>
                `
            });
            
            // Clinical Performance Benchmarking
            const topPerformers = data.filter(p => p.overallDischarge < 15 && p.appointments > 50).sort((a, b) => a.overallDischarge - b.overallDischarge);
            const strugglingPractitioners = data.filter(p => p.overallDischarge > 20);
            
            if (topPerformers.length > 0) {
                insights.push({
                    title: "üåü Clinical Excellence Benchmarking",
                    content: `
                        <p><strong>Top Performing Practitioners (discharge rate &lt;15%):</strong></p>
                        ${topPerformers.slice(0, 3).map(p => 
                            `<p>‚Ä¢ ${p.name}: ${p.overallDischarge.toFixed(1)}% discharge rate with ${p.appointments} consultations</p>`
                        ).join('')}
                        <p><strong>Practitioners Needing Support (&gt;20% discharge rate):</strong> ${strugglingPractitioners.length}</p>
                        <p><strong>Best Practice Opportunity:</strong> Top performers demonstrate that medicinal cannabis patient retention rates of &lt;15% are achievable</p>
                        <p><strong>Knowledge Transfer Value:</strong> Sharing successful clinical approaches could significantly improve overall retention rates</p>
                    `
                });
            }
            
            return insights;
        }

        // Generate strategic recommendations based on medicinal cannabis clinic context
        function generateRecommendations(data) {
            const recommendations = [];
            
            // Calculate key metrics for analysis
            const totalDischargeRate = data.reduce((sum, p) => sum + p.overallDischarge, 0) / data.length;
            const avgPatientDischarge = data.reduce((sum, p) => sum + p.patientDischarge, 0) / data.length;
            const avgPractitionerDischarge = data.reduce((sum, p) => sum + p.practitionerDischarge, 0) / data.length;
            
            // Immediate Actions - High-Impact Practitioners
            const criticalPractitioners = data.filter(p => p.overallDischarge > 20 && p.workloadShare > 10);
            if (criticalPractitioners.length > 0) {
                recommendations.push({
                    title: "üö® Immediate Revenue Protection Actions",
                    content: `
                        <p><strong>High-Risk Practitioners Affecting Revenue:</strong></p>
                        ${criticalPractitioners.map(p => 
                            `<p>‚Ä¢ <strong>${p.name}</strong>: ${p.overallDischarge.toFixed(1)}% discharge rate while handling ${p.workloadShare.toFixed(1)}% of consultations</p>`
                        ).join('')}
                        <p><strong>Financial Impact:</strong> These practitioners are losing patients who would typically generate 6+ months of recurring revenue.</p>
                        <p><strong>Actions:</strong></p>
                        <p>‚Ä¢ Schedule immediate clinical review meetings</p>
                        <p>‚Ä¢ Analyze discharge reasons (clinical vs. patient choice)</p>
                        <p>‚Ä¢ Consider temporary workload redistribution</p>
                        <p>‚Ä¢ Review patient education and expectation setting approaches</p>
                    `
                });
            }
            
            // Patient vs Practitioner Discharge Analysis
            if (avgPatientDischarge > avgPractitionerDischarge) {
                recommendations.push({
                    title: "üí∞ Patient-Initiated Discharge Strategy",
                    content: `
                        <p><strong>Alert:</strong> Patient-initiated discharges (${avgPatientDischarge.toFixed(1)}%) exceed practitioner-initiated (${avgPractitionerDischarge.toFixed(1)}%)</p>
                        <p><strong>Common Medicinal Cannabis Patient Exit Reasons:</strong></p>
                        <p>‚Ä¢ Cost concerns (PBS vs private prescriptions)</p>
                        <p>‚Ä¢ Lack of immediate results (expectation management)</p>
                        <p>‚Ä¢ Social stigma around cannabis use</p>
                        <p>‚Ä¢ Complex dosing or product confusion</p>
                        <p><strong>Retention Strategies:</strong></p>
                        <p>‚Ä¢ Implement financial consultation for cost-effective options</p>
                        <p>‚Ä¢ Create patient education program on realistic timelines</p>
                        <p>‚Ä¢ Develop peer support or success story sharing</p>
                        <p>‚Ä¢ Simplify product recommendations and dosing instructions</p>
                    `
                });
            } else {
                recommendations.push({
                    title: "ü©∫ Clinical Decision Review Process",
                    content: `
                        <p><strong>Analysis:</strong> Practitioner-initiated discharges (${avgPractitionerDischarge.toFixed(1)}%) exceed patient-initiated (${avgPatientDischarge.toFixed(1)}%)</p>
                        <p><strong>Potential Clinical Issues:</strong></p>
                        <p>‚Ä¢ Too-quick discharge for non-responders (need longer trial periods)</p>
                        <p>‚Ä¢ Insufficient product/dosage exploration</p>
                        <p>‚Ä¢ Overly strict eligibility criteria</p>
                        <p>‚Ä¢ Inadequate follow-up consultation scheduling</p>
                        <p><strong>Clinical Protocol Improvements:</strong></p>
                        <p>‚Ä¢ Establish minimum trial periods before discharge consideration</p>
                        <p>‚Ä¢ Create decision trees for product switching vs. discharge</p>
                        <p>‚Ä¢ Implement peer review for discharge decisions</p>
                        <p>‚Ä¢ Develop "rescue protocols" for marginal responders</p>
                    `
                });
            }
            
            // Team-Specific Actions
            const highVolumePractitioners = data.filter(p => p.workloadShare > 15);
            recommendations.push({
                title: "üë• Team-Specific Action Plan",
                content: `
                    <p><strong>Sales Team:</strong></p>
                    <p>‚Ä¢ Better pre-qualification to reduce unsuitable patient bookings</p>
                    <p>‚Ä¢ Set realistic expectations about treatment timelines and costs</p>
                    <p>‚Ä¢ Share discharge data to improve patient screening</p>
                    
                    <p><strong>Follow-Up Team:</strong></p>
                    <p>‚Ä¢ Implement proactive check-ins before discharge risk increases</p>
                    <p>‚Ä¢ Create intervention protocols for patients showing disengagement</p>
                    <p>‚Ä¢ Track 1-month follow-up completion rates vs. discharge correlation</p>
                    
                    <p><strong>Customer Support:</strong></p>
                    <p>‚Ä¢ Develop early warning system for patient dissatisfaction</p>
                    <p>‚Ä¢ Create retention conversation scripts for at-risk patients</p>
                    <p>‚Ä¢ Track support tickets that correlate with discharge patterns</p>
                    
                    <p><strong>High-Volume Practitioners (${highVolumePractitioners.length} identified):</strong></p>
                    <p>‚Ä¢ Provide additional administrative support to reduce burnout</p>
                    <p>‚Ä¢ Consider consultation time adjustments for complex cases</p>
                    <p>‚Ä¢ Implement structured discharge decision protocols</p>
                `
            });
            
            // Financial Impact & Targets
            const totalAppointments = data.reduce((sum, p) => sum + p.appointments, 0);
            const estimatedLostRevenue = Math.round((totalDischargeRate / 100) * totalAppointments * 6 * 200); // Assuming $200 per follow-up, 6 month cycle
            
            recommendations.push({
                title: "üíµ Financial Impact & Targets",
                content: `
                    <p><strong>Current Performance:</strong></p>
                    <p>‚Ä¢ Overall discharge rate: <span class="highlight-stat">${totalDischargeRate.toFixed(1)}%</span></p>
                    <p>‚Ä¢ Total consultations: <span class="highlight-stat">${totalAppointments.toLocaleString()}</span></p>
                    <p>‚Ä¢ Estimated annualized revenue impact: <span class="highlight-stat">${estimatedLostRevenue.toLocaleString()}</span></p>
                    
                    <p><strong>Target Improvements (6-month goals):</strong></p>
                    <p>‚Ä¢ Reduce overall discharge rate to <strong>12%</strong> (industry best practice)</p>
                    <p>‚Ä¢ Focus on patient-initiated discharges (highest retention ROI)</p>
                    <p>‚Ä¢ Improve 1-month follow-up attendance to reduce discharge risk</p>
                    
                    <p><strong>Success Metrics to Track:</strong></p>
                    <p>‚Ä¢ Patient lifetime value (LTV) increase</p>
                    <p>‚Ä¢ Average treatment duration before discharge</p>
                    <p>‚Ä¢ Practitioner-specific retention improvement</p>
                    <p>‚Ä¢ Cost per patient acquisition vs. retention investment</p>
                `
            });
            
            // System-Level Improvements
            recommendations.push({
                title: "üîß System-Level Retention Improvements",
                content: `
                    <p><strong>Patient Journey Optimization:</strong></p>
                    <p>‚Ä¢ Implement discharge risk scoring based on appointment patterns</p>
                    <p>‚Ä¢ Create automated follow-up sequences for missed appointments</p>
                    <p>‚Ä¢ Develop patient satisfaction surveys at key touchpoints</p>
                    
                    <p><strong>Clinical Workflow Enhancements:</strong></p>
                    <p>‚Ä¢ Standardize initial consultation assessment protocols</p>
                    <p>‚Ä¢ Create treatment escalation pathways before discharge consideration</p>
                    <p>‚Ä¢ Implement structured discharge criteria and approval process</p>
                    
                    <p><strong>Technology Solutions:</strong></p>
                    <p>‚Ä¢ Patient portal for education and engagement between visits</p>
                    <p>‚Ä¢ Automated alerts for practitioners when discharge rates exceed thresholds</p>
                    <p>‚Ä¢ Integration with patient feedback systems to identify retention opportunities</p>
                    
                    <p><strong>Training & Development:</strong></p>
                    <p>‚Ä¢ Best practice sharing sessions between high and low-discharge practitioners</p>
                    <p>‚Ä¢ Patient communication and expectation management training</p>
                    <p>‚Ä¢ Medicinal cannabis education updates for evolving treatment protocols</p>
                `
            });
            
            return recommendations;
        }

        // Update sections
        function updateInsightsSection(insights) {
            const content = document.getElementById('insightsContent');
            content.innerHTML = `
                <div class="insight-grid">
                    ${insights.map(insight => `
                        <div class="insight-card">
                            <h4>${insight.title}</h4>
                            ${insight.content}
                        </div>
                    `).join('')}
                </div>
            `;
        }

        function updateRecommendationsSection(recommendations) {
            const content = document.getElementById('recommendationsContent');
            content.innerHTML = `
                <div class="insight-grid">
                    ${recommendations.map(rec => `
                        <div class="insight-card">
                            <h4>${rec.title}</h4>
                            ${rec.content}
                        </div>
                    `).join('')}
                </div>
            `;
        }

        // Create discharge charts
        function createDischargeCharts(data) {
            if (typeof Chart === 'undefined') {
                setTimeout(() => createDischargeCharts(data), 500);
                return;
            }

            if (charts.discharge) charts.discharge.destroy();
            if (charts.distribution) charts.distribution.destroy();

            try {
                const ctx1 = document.getElementById('dischargeChart');
                charts.discharge = new Chart(ctx1.getContext('2d'), {
                    type: 'bar',
                    data: {
                        labels: data.map(p => p.name),
                        datasets: [
                            {
                                label: 'Patient Discharge %',
                                data: data.map(p => p.patientDischarge),
                                backgroundColor: 'rgba(59, 130, 246, 0.8)',
                                borderColor: '#3b82f6',
                                borderWidth: 2
                            },
                            {
                                label: 'Practitioner Discharge %',
                                data: data.map(p => p.practitionerDischarge),
                                backgroundColor: 'rgba(16, 185, 129, 0.8)',
                                borderColor: '#10b981',
                                borderWidth: 2
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                labels: { color: '#e2e8f0' }
                            }
                        },
                        scales: {
                            x: {
                                ticks: { color: '#cbd5e1' },
                                grid: { color: '#475569' }
                            },
                            y: {
                                beginAtZero: true,
                                ticks: { color: '#cbd5e1' },
                                grid: { color: '#475569' }
                            }
                        }
                    }
                });

                const totalPatientDischarges = data.reduce((sum, p) => sum + p.patientDischarge, 0);
                const totalPractitionerDischarges = data.reduce((sum, p) => sum + p.practitionerDischarge, 0);

                const ctx2 = document.getElementById('distributionChart');
                charts.distribution = new Chart(ctx2.getContext('2d'), {
                    type: 'doughnut',
                    data: {
                        labels: ['Patient Initiated', 'Practitioner Initiated'],
                        datasets: [{
                            data: [totalPatientDischarges, totalPractitionerDischarges],
                            backgroundColor: ['#3b82f6', '#10b981'],
                            borderWidth: 3,
                            borderColor: '#1e293b'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'bottom',
                                labels: {
                                    color: '#e2e8f0',
                                    padding: 20
                                }
                            }
                        }
                    }
                });
            } catch (error) {
                console.error('Error creating charts:', error);
            }
        }

        // Initialize dashboard
        async function initDashboard() {
            try {
                console.log('Initializing discharge dashboard...');
                const data = await fetchDischargeData();
                updateDashboard(data);
                
                document.getElementById('loading').style.display = 'none';
                document.getElementById('dashboard').style.display = 'block';
                
                console.log('Dashboard loaded successfully!');
            } catch (error) {
                console.error('Error initializing dashboard:', error);
                
                const fallbackData = [
                    { name: 'Dr. Sarah Mitchell', patientDischarge: 12.5, practitionerDischarge: 8.2, appointments: 142, overallDischarge: 20.7 },
                    { name: 'Dr. James Wilson', patientDischarge: 18.3, practitionerDischarge: 5.1, appointments: 89, overallDischarge: 23.4 },
                    { name: 'Dr. Emily Chen', patientDischarge: 9.7, practitionerDischarge: 12.8, appointments: 203, overallDischarge: 22.5 }
                ];
                
                updateDashboard(fallbackData);
                document.getElementById('dataSource').innerHTML = '‚ö†Ô∏è Using demo data - Google Sheets connection failed';
                
                document.getElementById('loading').style.display = 'none';
                document.getElementById('dashboard').style.display = 'block';
            }
        }

        // Start the dashboard when page loads
        window.addEventListener('load', initDashboard);
    </script>
</body>
</html>
